<!DOCTYPE html>
<html>
<head>
  <title>caulde control</title>
  <style>
    body {
      background: #0b0b0b;
      color: #eaeaea;
      font-family: monospace;
      padding: 20px;
    }
    .draft {
      border: 1px solid #333;
      padding: 12px;
      margin-bottom: 12px;
    }
    .meta {
      color: #777;
      font-size: 12px;
    }
    button {
      margin-right: 8px;
      cursor: pointer;
    }
    .btn-red {
        background-color: #3f0000;
        color: #ffcccc;
        border: 1px solid #770000;
        padding: 5px 10px;
        float: right;
    }
    .btn-red:hover {
        background-color: #770000;
        color: white;
    }
  </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>caulde drafts</h2>
    <button onclick="clearAll()" class="btn-red">CLEAR ALL</button>
</div>

<button id="btn-random" onclick="generatePost()">generate dumb post</button>
<br/><br/>

<textarea id="promptBox" rows="3" style="width:100%; margin-bottom:8px;"
  placeholder="type a vibe, thought, or instruction…"></textarea>

<button id="btn-prompt" onclick="sendPrompt()">generate post</button>

<br/><br/>

<div id="drafts">loading...</div>

<script>
async function loadDrafts() {
  const res = await fetch("/drafts");
  const drafts = await res.json();

  const container = document.getElementById("drafts");
  container.innerHTML = "";

  if (!drafts.length) {
    container.innerHTML = "<p>no drafts</p>";
    return;
  }

  drafts.forEach(d => {
    if (d.posted) return;
    const div = document.createElement("div");
    div.className = "draft";
    div.innerHTML = `
      <div class="meta">${d.kind}</div>
      ${d.kind === "reply" && d.context ? `<div style="color:#888; font-size:12px; margin-bottom:6px;">↳ ${d.context}</div>` : ""}
      <div>${d.text}</div><br/>
      <button onclick="approve(${d.id})">YES</button>
      <button onclick="discardDraft(${d.id})">NO</button>
    `;
    container.appendChild(div);
  });
}

async function approve(id) {
  await fetch(`/approve/${id}`, { method: "POST" });
  loadDrafts();
}

async function discardDraft(id) {
  await fetch(`/discard/${id}`, { method: "POST" });
  loadDrafts();
}

// --- NEW FUNCTION ---
async function clearAll() {
    if(!confirm("DELETE ALL DRAFTS?")) return;
    await fetch("/discard_all", { method: "POST" });
    loadDrafts();
}

async function generatePost() {
  const btn = document.getElementById("btn-random");
  btn.innerText = "generating...";
  btn.disabled = true;

  try {
      await fetch("/generate_post", { method: "POST" });
      loadDrafts();
  } catch (e) {
      alert("Error");
  } finally {
      btn.innerText = "generate dumb post";
      btn.disabled = false;
  }
}

async function sendPrompt() {
  const box = document.getElementById("promptBox");
  const btn = document.getElementById("btn-prompt");
  const text = box.value.trim();
  
  if (!text) return;

  btn.disabled = true;
  btn.innerText = "generating...";
  
  try {
    await fetch("/prompt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: text })
    });
    box.value = ""; 
    loadDrafts(); 
  } catch (e) {
    alert("Error sending prompt");
  } finally {
    btn.disabled = false;
    btn.innerText = "generate post";
  }
}

loadDrafts();
setInterval(loadDrafts, 5000);
</script>

</body>
</html>